# Bulk Create Test Case API

## Overview
The bulk create API allows you to create multiple test cases in a single request using a "best-effort" strategy. This means the system will attempt to create all test cases, save the ones that succeed, and report detailed errors for the ones that fail.

## Endpoint

```
POST /testcases/bulk
```

## Request Format

The request body must contain a `testCases` array where each element has the same structure as a single test case creation request.

```json
{
  "testCases": [
    {
      "name": "Test Case Name",
      "description": "Test case description",
      "type": "positive",
      "priority": "high",
      "steps": [
        {
          "step": "Step description",
          "expectedResult": "Expected result"
        }
      ],
      "expectedResult": "Overall expected result",
      "tags": ["tag1", "tag2"]
    }
  ]
}
```

### Test Case Object Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Test case name |
| `description` | string | Yes | Test case description |
| `type` | enum | Yes | "positive" or "negative" |
| `priority` | enum | Yes | "high", "medium", or "low" |
| `steps` | array | Yes | Array of step objects |
| `expectedResult` | string | Yes | Overall expected result |
| `tags` | array | Yes | Array of tag strings |
| `aiGenerated` | boolean | No | Whether generated by AI |
| `originalPrompt` | string | No | Original AI prompt |
| `aiConfidence` | number | No | AI confidence score (0-1) |
| `aiSuggestions` | string | No | AI suggestions |
| `aiGenerationMethod` | string | No | "pure_ai" or "rag" |
| `referenceTo` | string | No | Reference test case ID |
| `referenceType` | string | No | "manual", "rag_retrieval", or "semantic_search" |
| `ragReferences` | array | No | Array of RAG reference objects |
| `tokenUsage` | object | No | Token usage metadata |

## Response Format

The response includes detailed results for each test case creation attempt and summary statistics.

```json
{
  "results": [
    {
      "success": true,
      "data": {
        "id": "test-case-id",
        "name": "Test Case Name",
        "description": "Test case description",
        "type": "positive",
        "priority": "high",
        "steps": [...],
        "expectedResult": "Overall expected result",
        "tags": ["tag1", "tag2"],
        "createdAt": "2025-11-10T02:00:00.000Z",
        "updatedAt": "2025-11-10T02:00:00.000Z"
      },
      "index": 0
    },
    {
      "success": false,
      "error": "Error message describing what went wrong",
      "index": 1
    }
  ],
  "total": 2,
  "successCount": 1,
  "failureCount": 1
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `results` | array | Array of individual results for each test case |
| `results[].success` | boolean | Whether the test case was created successfully |
| `results[].data` | object | The created test case (only present on success) |
| `results[].error` | string | Error message (only present on failure) |
| `results[].index` | number | Index of the test case in the input array |
| `total` | number | Total number of test cases in the request |
| `successCount` | number | Number of successfully created test cases |
| `failureCount` | number | Number of failed test case creations |

## Examples

### Example 1: Creating Multiple Test Cases

**Request:**
```bash
curl -X POST http://localhost:3000/testcases/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "testCases": [
      {
        "name": "Test Login Success",
        "description": "Test successful login with valid credentials",
        "type": "positive",
        "priority": "high",
        "steps": [
          {
            "step": "Navigate to login page",
            "expectedResult": "Login page is displayed"
          },
          {
            "step": "Enter valid username and password",
            "expectedResult": "Credentials are accepted"
          },
          {
            "step": "Click login button",
            "expectedResult": "User is redirected to dashboard"
          }
        ],
        "expectedResult": "User successfully logs in and sees the dashboard",
        "tags": ["login", "authentication", "positive"]
      },
      {
        "name": "Test Login Failure - Invalid Password",
        "description": "Test login with invalid password",
        "type": "negative",
        "priority": "medium",
        "steps": [
          {
            "step": "Navigate to login page",
            "expectedResult": "Login page is displayed"
          },
          {
            "step": "Enter valid username but invalid password",
            "expectedResult": "Invalid credentials entered"
          },
          {
            "step": "Click login button",
            "expectedResult": "Error message is shown"
          }
        ],
        "expectedResult": "User sees an error message and stays on login page",
        "tags": ["login", "authentication", "negative", "validation"]
      },
      {
        "name": "Test Logout",
        "description": "Test user logout functionality",
        "type": "positive",
        "priority": "medium",
        "steps": [
          {
            "step": "User is already logged in",
            "expectedResult": "Dashboard is displayed"
          },
          {
            "step": "Click logout button",
            "expectedResult": "User is logged out"
          }
        ],
        "expectedResult": "User is redirected to login page",
        "tags": ["logout", "authentication"]
      }
    ]
  }'
```

**Response:**
```json
{
  "results": [
    {
      "success": true,
      "data": {
        "id": "clx1a2b3c4d5e6f7g8h9i0j",
        "name": "Test Login Success",
        "description": "Test successful login with valid credentials",
        "type": "positive",
        "priority": "high",
        "steps": [...],
        "expectedResult": "User successfully logs in and sees the dashboard",
        "tags": ["login", "authentication", "positive"],
        "aiGenerated": false,
        "createdAt": "2025-11-10T02:00:00.000Z",
        "updatedAt": "2025-11-10T02:00:00.000Z"
      },
      "index": 0
    },
    {
      "success": true,
      "data": {
        "id": "clx1a2b3c4d5e6f7g8h9i0k",
        "name": "Test Login Failure - Invalid Password",
        "description": "Test login with invalid password",
        "type": "negative",
        "priority": "medium",
        "steps": [...],
        "expectedResult": "User sees an error message and stays on login page",
        "tags": ["login", "authentication", "negative", "validation"],
        "aiGenerated": false,
        "createdAt": "2025-11-10T02:00:00.000Z",
        "updatedAt": "2025-11-10T02:00:00.000Z"
      },
      "index": 1
    },
    {
      "success": true,
      "data": {
        "id": "clx1a2b3c4d5e6f7g8h9i0l",
        "name": "Test Logout",
        "description": "Test user logout functionality",
        "type": "positive",
        "priority": "medium",
        "steps": [...],
        "expectedResult": "User is redirected to login page",
        "tags": ["logout", "authentication"],
        "aiGenerated": false,
        "createdAt": "2025-11-10T02:00:00.000Z",
        "updatedAt": "2025-11-10T02:00:00.000Z"
      },
      "index": 2
    }
  ],
  "total": 3,
  "successCount": 3,
  "failureCount": 0
}
```

### Example 2: Best-Effort Strategy (Mixed Success/Failure)

**Request:**
```bash
curl -X POST http://localhost:3000/testcases/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "testCases": [
      {
        "name": "Valid Test Case",
        "description": "This will succeed",
        "type": "positive",
        "priority": "high",
        "steps": [
          {
            "step": "Step 1",
            "expectedResult": "Result 1"
          }
        ],
        "expectedResult": "Success",
        "tags": ["valid"]
      },
      {
        "name": "",
        "description": "This will fail - empty name",
        "type": "positive",
        "priority": "high",
        "steps": [],
        "expectedResult": "This should fail",
        "tags": []
      },
      {
        "name": "Another Valid Test Case",
        "description": "This will succeed",
        "type": "negative",
        "priority": "medium",
        "steps": [
          {
            "step": "Step 1",
            "expectedResult": "Result 1"
          }
        ],
        "expectedResult": "Success",
        "tags": ["valid"]
      }
    ]
  }'
```

**Response:**
```json
{
  "results": [
    {
      "success": true,
      "data": {
        "id": "clx1a2b3c4d5e6f7g8h9i0m",
        "name": "Valid Test Case",
        ...
      },
      "index": 0
    },
    {
      "success": false,
      "error": "Failed to create test case",
      "index": 1
    },
    {
      "success": true,
      "data": {
        "id": "clx1a2b3c4d5e6f7g8h9i0n",
        "name": "Another Valid Test Case",
        ...
      },
      "index": 2
    }
  ],
  "total": 3,
  "successCount": 2,
  "failureCount": 1
}
```

### Example 3: Bulk Create with AI Metadata

**Request:**
```bash
curl -X POST http://localhost:3000/testcases/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "testCases": [
      {
        "name": "AI Generated Test Case 1",
        "description": "Generated by AI with RAG",
        "type": "positive",
        "priority": "high",
        "steps": [
          {
            "step": "Execute action",
            "expectedResult": "Expected outcome"
          }
        ],
        "expectedResult": "Test passes",
        "tags": ["ai-generated"],
        "aiGenerated": true,
        "originalPrompt": "Create a test case for feature X",
        "aiConfidence": 0.85,
        "aiGenerationMethod": "rag",
        "ragReferences": [
          {
            "testCaseId": "existing-test-case-id",
            "similarity": 0.82
          }
        ]
      }
    ]
  }'
```

## Features

### 1. Best-Effort Strategy
The API uses a best-effort strategy, which means:
- All test cases are processed sequentially
- If one test case fails, the others continue to be processed
- Each result is tracked individually with success/failure status
- Failed creations don't affect successful ones

### 2. Comprehensive Error Reporting
Each failed test case creation includes:
- `success: false` flag
- Detailed error message describing what went wrong
- Index to map back to the input array

### 3. Full Feature Support
All features available in single test case creation are supported:
- **AI Metadata**: `aiGenerated`, `originalPrompt`, `aiConfidence`, `aiSuggestions`, `aiGenerationMethod`, `tokenUsage`
- **References**: `referenceTo`, `referenceType`
- **RAG References**: `ragReferences` array with similarity scores
- **Automatic Embeddings**: Generated automatically for semantic search

### 4. Automatic Embedding Generation
- Embeddings are generated in parallel for all test cases
- If embedding generation fails, the test case is created with an empty embedding
- This ensures the best-effort strategy is maintained

### 5. Reference Handling
- References are created for successfully created test cases
- If reference creation fails, the test case is still saved
- Reference failures don't break the entire operation

## Error Handling

### Validation Errors
If the input format is invalid (e.g., missing required fields, invalid types), you'll receive a `400 Bad Request` response with validation details:

```json
{
  "statusCode": 400,
  "message": [
    "testCases.0.name should not be empty",
    "testCases.0.type must be one of: positive, negative"
  ],
  "error": "Bad Request"
}
```

### Individual Test Case Errors
Failed test case creations are included in the response with detailed information:

```json
{
  "success": false,
  "error": "Failed to create test case",
  "index": 1
}
```

Common error scenarios:
- Invalid enum values (type, priority)
- Database constraints violations
- Embedding generation failures (handled gracefully)
- Reference creation failures (test case still saved)

## Performance Considerations

### Processing Strategy
- Test cases are created **sequentially** to ensure database consistency
- Embeddings are generated **in parallel** for better performance
- References are created **asynchronously** for each successful test case

### Batch Size Recommendations
- **Recommended**: 50-100 test cases per request
- **Maximum**: No hard limit, but larger batches take longer
- **Tip**: For large datasets, split into multiple smaller batches

### Response Time
- Base time: ~100-200ms per test case
- Additional time for embeddings: ~50-100ms per test case (parallel)
- Additional time for references: ~10-20ms per test case

## Best Practices

1. **Validate Input**: Validate your data before sending to reduce failures
2. **Check Statistics**: Always check `successCount` and `failureCount` in the response
3. **Handle Failures**: Process failed creations separately if needed
4. **Use Indexing**: Use the `index` field to map results back to your input data
5. **Monitor Performance**: Track response times for large batches
6. **Retry Failed**: Consider retrying failed creations after fixing the issues
7. **Batch Appropriately**: Keep batch sizes reasonable (50-100 items)

## Use Cases

1. **Bulk Import**: Import test cases from external systems or files
2. **Template Creation**: Create multiple similar test cases at once
3. **Data Migration**: Migrate test cases from legacy systems
4. **Automated Generation**: Save multiple AI-generated test cases
5. **Test Suite Creation**: Create complete test suites in one request
6. **Batch Operations**: Efficient creation of related test cases

## Comparison with Single Create

| Feature | Single Create | Bulk Create |
|---------|---------------|-------------|
| Endpoint | POST /testcases | POST /testcases/bulk |
| Input | Single object | Array of objects |
| Response | Created test case | Results array + statistics |
| Error Handling | Fails immediately | Best-effort (continues) |
| Use Case | Creating one | Creating many |
| Performance | ~100-200ms | ~100-200ms per item |

## API Documentation

For interactive API documentation, visit the Swagger UI when the backend is running:

```
http://localhost:3000/api
```

Look for the `POST /testcases/bulk` endpoint under the "testcases" tag.

## Support

For issues or questions:
- Check the [main README](../README.md)
- Review the [API documentation](http://localhost:3000/api)
- Open an issue on GitHub
